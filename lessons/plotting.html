<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="viewport" content="width=device-width">
<link rel="stylesheet" href="/edh7916/assets/css/style.css">
<link rel="stylesheet" href="/edh7916/assets/css/syntax_default.css">
<link rel="shortcut icon" type="image/png" href="/edh7916/assets/img/favicon.ico">
<link crossorigin="anonymous" media="all" integrity="sha512-uhAd27cNiLn0VE2GVEVUN8D5zW0o7s0QTnCGMnJZkL2HqN9/LwHDi4ndTPJH0upUQHYl/8QF6cwbOYp/KIzlJQ==" rel="stylesheet" href="https://github.githubassets.com/assets/github-be4e45349cf088df7a6636f437c0a167.css" />
<script defer src="/edh7916/assets/js/all.min.js"></script>
<!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script async defer src="https://buttons.github.io/buttons.js"></script>
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

<title>edquant | EDH 7916: Contemporary Research in Higher Education</title>

  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>EDH 7916: Contemporary Research in Higher Education<a href="https://github.com/edquant/edh7916" class="iconlink">
	      <i class="fab fa-github fa-sm"></i></a></h1>
	<h2 class="thin">Spring 2022</h2>
	<p>A course in quantitative research workflow for students in
the higher education administration program at the University of Florida
</p>
	<!-- side / top bar menu -->
	<h2 class="thin">
	  <a href="/edh7916/">Overview</a></br>
	  <a href="/edh7916/syllabus/">Course information</a></br>
	  <a href="/edh7916/location/">Meeting location</a></br>
	  <a href="/edh7916/software/">Software</a></br>
	  <a href="/edh7916/schedule/">Schedule</a></br>
	  <a href="/edh7916/lessons/">Lessons</a></br>
	  <a href="/edh7916/assignments/">Assignments</a></br>
	  <a href="/edh7916/questions/">Questions</a></br>
	  <a href="/edh7916/past/">Past courses</a></br>
	  <a href="/edh7916/about/">About</a></br>	  
	</h2>
      </header>

      <section>
	<h1>Data Visualization with ggplot2</h1>
	

	
<p>
  
  <a href="/edh7916/assets/pdf/plotting.pdf"
     class="iconlink" download title="Get PDF of lesson">
  <i class="far fa-file-pdf fa-2x"></i>
  </a>
  
  &nbsp;&nbsp;
  
  <a href="/edh7916/scripts/plotting.R"
     class="iconlink" download title="Get script">
    <i class="fas fa-code fa-2x"></i>
  </a>
  &nbsp;&nbsp;
  
  
  
  
  
  <a href="/edh7916/data/hsls_small.dta"
     class="iconlink" download title="Get data">
    <i class="fas fa-database fa-2x"></i>
  </a>
  &nbsp;&nbsp;
  
  <a href="/edh7916/data/sch_test.zip"
     class="iconlink" download title="Get data">
    <i class="fas fa-database fa-2x"></i>
  </a>
  &nbsp;&nbsp;
  
  
</p>


<p>One key part of understanding your data and presenting your analyses
lies making plots. This lesson will focus on graphics.</p>

<p>R has three major graphing systems: the <a href="https://stat.ethz.ch/R-manual/R-devel/library/graphics/html/00Index.html">base
system</a>,
<a href="http://lattice.r-forge.r-project.org">lattice</a>, and
<a href="http://ggplot2.tidyverse.org">ggplot2</a>. Each system has its benefits
and drawbacks. Each is also very versatile with many, many options for
creating and adjusting plots.</p>

<p>Unfortunately, there isn’t enough time to go through all three
graphing systems. After describing a few base R graphing functions,
this lesson will focus on using ggplot2 since it allows users to build
plots using the <a href="http://vita.had.co.nz/papers/layered-grammar.html">grammar of
graphics</a> and
integrates well with the tidyverse.</p>

<h1 id="setup">Setup</h1>

<p>We’re using two libraries today:</p>

<ul>
  <li><a href="http://ggplot2.tidyverse.org">ggplot2</a></li>
  <li><a href="http://haven.tidyverse.org">haven</a></li>
</ul>

<p>The <a href="http://ggplot2.tidyverse.org">ggplot2</a> library is part of the
tidyverse, so we don’t need to load it separately (we can
just use <code class="language-plaintext highlighter-rouge">library(tidyverse)</code> as always).</p>

<p>We’re also going to use <a href="http://haven.tidyverse.org">haven</a>, which
allows us to read in data files from other software such as SPSS, SAS,
and Stata. We’ll use it to read in a Stata (<code class="language-plaintext highlighter-rouge">*.dta</code>) version of the
small HSLS data we’ve used before. The Stata version, unlike the plain
CSV version, has labels for the variables and values. These will be
useful when plotting.</p>

<p>Though haven is part of the tidyverse (and should have been installed
when you installed tidyverse), we’ll have to explicitly call it.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## ---------------------------</span><span class="w">
</span><span class="c1">## libraries</span><span class="w">
</span><span class="c1">## ---------------------------</span><span class="w">

</span><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## ── Attaching packages ─────────────────────────────────────── tidyverse 1.3.1 ──
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## ✔ ggplot2 3.3.5     ✔ purrr   0.3.4
## ✔ tibble  3.1.6     ✔ dplyr   1.0.7
## ✔ tidyr   1.1.4     ✔ stringr 1.4.0
## ✔ readr   2.1.1     ✔ forcats 0.5.1
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">haven</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>In addition to the Stata version of small HSLS, we’ll also be using
<code class="language-plaintext highlighter-rouge">all_schools.csv</code> in the lesson. <a href="../lessons/dw_two.html">As in the prior
lesson</a>, unzip the file and place the entire
<code class="language-plaintext highlighter-rouge">sch_test</code> subdirectory will all included files in the <code class="language-plaintext highlighter-rouge">data</code>
subdirectory (if you don’t already have it). After including its
subdirectory path (<code class="language-plaintext highlighter-rouge">tsc_dir</code>), we’ll read in both data files.</p>

<p><strong>Note</strong> that since we have two data files this lesson, we’ll give
them unique names instead of the normal <code class="language-plaintext highlighter-rouge">df</code>:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">df_hs</code> := <code class="language-plaintext highlighter-rouge">hsls_small.dta</code></li>
  <li><code class="language-plaintext highlighter-rouge">df_ts</code> := <code class="language-plaintext highlighter-rouge">all_schools.csv</code></li>
</ul>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## ---------------------------</span><span class="w">
</span><span class="c1">## directory paths</span><span class="w">
</span><span class="c1">## ---------------------------</span><span class="w">

</span><span class="c1">## assume we're running this script from the ./scripts subdirectory</span><span class="w">
</span><span class="n">dat_dir</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">file.path</span><span class="p">(</span><span class="s2">".."</span><span class="p">,</span><span class="w"> </span><span class="s2">"data"</span><span class="p">)</span><span class="w">
</span><span class="n">tsc_dir</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">file.path</span><span class="p">(</span><span class="n">dat_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"sch_test"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## ---------------------------</span><span class="w">
</span><span class="c1">## input data</span><span class="w">
</span><span class="c1">## ---------------------------</span><span class="w">

</span><span class="c1">## assume we're running this script from the ./scripts subdirectory</span><span class="w">
</span><span class="c1">## read_dta() ==&gt; read in Stata (*.dta) files</span><span class="w">
</span><span class="c1">## read_csv() ==&gt; read in comma separated value (*.csv) files</span><span class="w">
</span><span class="n">df_hs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_dta</span><span class="p">(</span><span class="n">file.path</span><span class="p">(</span><span class="n">dat_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"hsls_small.dta"</span><span class="p">))</span><span class="w">
</span><span class="n">df_ts</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="n">file.path</span><span class="p">(</span><span class="n">tsc_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"all_schools.csv"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## Rows: 24 Columns: 5
## ── Column specification ────────────────────────────────────────────────────────
## Delimiter: ","
## chr (1): school
## dbl (4): year, math, read, science
## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
</code></pre></div></div>

<h1 id="plots-using-base-r">Plots using base R</h1>

<p>Even though new graphics libraries have been developed, the base R
graphics system remains powerful. The base system is also very easy to
use in a pinch. When I want a quick visual of a data distribution
that’s just for me, I often use base R.</p>

<p><strong>Note</strong> that for the next few plots, I’m not much concerned with how
they look. Specifically, the axis labels won’t look very nice. We
could spend time learning to make really nice base R plots for
publication, but I’d rather we spend that time with ggplot2 graphics.</p>

<p><strong>Also note</strong> that we’ll switch to using the base R data frame <code class="language-plaintext highlighter-rouge">$</code>
notation to pull out the columns we want. If you need some more
information on using <code class="language-plaintext highlighter-rouge">$</code> notation, <a href="../lessons/dw_one_base_r.html">check out the supplemental lesson
on data wrangling with base R</a>.</p>

<h2 id="histogram">Histogram</h2>

<p>For continuous variables, a histogram is a useful plot. Though the
<code class="language-plaintext highlighter-rouge">hist()</code> function has many options to adjust how it looks, the
defaults work really well if you just want a quick look at the
distribution.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## histogram of math scores (which should be normal by design)</span><span class="w">
</span><span class="n">hist</span><span class="p">(</span><span class="n">df_hs</span><span class="o">$</span><span class="n">x1txmtscor</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/eda_base_histogram-1.png" title="plot of chunk eda_base_histogram" alt="plot of chunk eda_base_histogram" width="100%" /></p>

<blockquote>
  <h4 id="quick-exercise">Quick exercise</h4>
  <p>Check the distribution of the students’ socioeconomic score (SES).</p>
</blockquote>

<h2 id="density">Density</h2>

<p>Density plots are also really helpful. R doesn’t have single density
plot function, but you can get a density plot in one of two ways, each
of which will give a slightly different result.</p>

<p>First, you can adjust the <code class="language-plaintext highlighter-rouge">hist()</code> function to add the <code class="language-plaintext highlighter-rouge">freq = FALSE</code>
argument. It looks like the first histogram above, but notice that the
y-axis now represents density rather than counts.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## density plot of math scores with hist() function</span><span class="w">
</span><span class="n">hist</span><span class="p">(</span><span class="n">df_hs</span><span class="o">$</span><span class="n">x1txmtscor</span><span class="p">,</span><span class="w"> </span><span class="n">freq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/eda_base_hist_density-1.png" title="plot of chunk eda_base_hist_density" alt="plot of chunk eda_base_hist_density" width="100%" /></p>

<p>Second, you can <code class="language-plaintext highlighter-rouge">plot()</code> the <code class="language-plaintext highlighter-rouge">density()</code> of a continuous
variable. Unlike <code class="language-plaintext highlighter-rouge">hist()</code>, however, <code class="language-plaintext highlighter-rouge">density()</code> doesn’t automatically
ignore missing values, so we have to tell it to remove <code class="language-plaintext highlighter-rouge">NA</code>s using the
<code class="language-plaintext highlighter-rouge">na.rm = TRUE</code> argument (a common argument for base R functions that’s
useful to remember).</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## density plot of math scores</span><span class="w">
</span><span class="c1">## read inside out: get density value, then plot values</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">density</span><span class="p">(</span><span class="n">df_hs</span><span class="o">$</span><span class="n">x1txmtscor</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/eda_base_density-1.png" title="plot of chunk eda_base_density" alt="plot of chunk eda_base_density" width="100%" /></p>

<blockquote>
  <h4 id="quick-exercise-1">Quick exercise</h4>
  <p>Plot the density of SES. Next, add the <code class="language-plaintext highlighter-rouge">col</code>
argument in <code class="language-plaintext highlighter-rouge">plot()</code> to change the color of the line to <code class="language-plaintext highlighter-rouge">"red"</code>:
<code class="language-plaintext highlighter-rouge">plot(density(df_hs$x1txtmscor, na.rm = TRUE), col = "red")</code>.</p>
</blockquote>

<h2 id="box-plot">Box plot</h2>

<p>A box plot will let you see the distribution of a continuous variable
at specific values of another discrete variable. For example, test
scores ranges at each student expectation level.</p>

<p>Call a box plot using the <code class="language-plaintext highlighter-rouge">boxplot()</code> function. This one is a little
trickier because it uses the <a href="https://www.statmethods.net/graphs/boxplot.html">R
formula</a> construction
to set the continuous variable against the discrete variable. The formula uses a
tilde, <code class="language-plaintext highlighter-rouge">~</code>, and should be constructed like this:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">&lt;continuous var&gt; ~ &lt;discrete var&gt;</code></li>
</ul>

<p>Notice how we can use the <code class="language-plaintext highlighter-rouge">data = df_hs</code> argument instead of adding
<code class="language-plaintext highlighter-rouge">df_hs$</code> in front of the variable names. This saves us some typing.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## box plot of math scores against student expectations</span><span class="w">
</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x1txmtscor</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">x1stuedexpct</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_hs</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/eda_base_box-1.png" title="plot of chunk eda_base_box" alt="plot of chunk eda_base_box" width="100%" /></p>

<p>From the boxplot, we can see that math test scores tend to increase as
students’ educational expectations increase (remember that 11 means “I
don’t know [how far I’ll go in school]”), though there’s quite a bit
of overlap in the marginal distributions.</p>

<h2 id="scatter">Scatter</h2>

<p>Plot two continuous variables against one another using the base
<code class="language-plaintext highlighter-rouge">plot()</code> function. There are two primary ways to make a scatter plot
using <code class="language-plaintext highlighter-rouge">plot()</code>:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">plot(x, y)</code></li>
  <li><code class="language-plaintext highlighter-rouge">plot(y ~ x)</code></li>
</ul>

<p>With both, <code class="language-plaintext highlighter-rouge">x</code> is the variable that will go on the x-axis and <code class="language-plaintext highlighter-rouge">y</code> the
one that will go on the y-axis. It’s really a matter of which makes
sense to you. We’ll use the first.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## scatter plot of math against SES</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">df_hs</span><span class="o">$</span><span class="n">x1ses</span><span class="p">,</span><span class="w"> </span><span class="n">df_hs</span><span class="o">$</span><span class="n">x1txmtscor</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/eda_base_scatter-1.png" title="plot of chunk eda_base_scatter" alt="plot of chunk eda_base_scatter" width="100%" /></p>

<p>While the data seem to show a positive correlation between
socioeconomic status and math test score, there’s also quite a bit of
variation in that association (notice that the cloud-like nature of
the circles).</p>

<blockquote>
  <h4 id="quick-exercise-2">Quick exercise</h4>
  <p>Rerun the above plot, but this time store it in an object,
<code class="language-plaintext highlighter-rouge">plot_1</code>. Next, make the same plot, but this time use the second
formula construction (<code class="language-plaintext highlighter-rouge">~</code>) — store it in an object,
<code class="language-plaintext highlighter-rouge">plot_2</code>. Visually compare the two, but for a more formal test, use
<code class="language-plaintext highlighter-rouge">identical(plot_1, plot_2)</code> on the two plot objects to prove they
are the same.</p>
</blockquote>

<h1 id="plots-using-ggplot2">Plots using ggplot2</h1>

<p>ggplot2 is my — and many R users’ — primary system for making
plots. It is based on the idea of a <a href="https://www.springer.com/gp/book/9780387245447">grammar of
graphics</a>. Just as we
can use finite rules of a language grammar to construct an endless
number of unique sentences, so too can we use a few graphical
grammatical rules to make an endless number of unique figures.</p>

<p>The <a href="http://ggplot2.tidyverse.org/reference/">ggplot2 system</a> is too
involved to cover in all of its details, but that’s kind of the point
of the grammar of graphics: once you see how it’s put together, you
can anticipate the commands you need to build your plot.</p>

<p>We’ll start by covering the same plots as above.</p>

<h2 id="histogram-1">Histogram</h2>

<p><a href="http://ggplot2.tidyverse.org">As the main help site says</a>, all
ggplot2 plots need three things:</p>

<ul>
  <li><strong>[data]</strong>: The source of the variables you want to plot</li>
  <li><strong>[aesthetics]</strong>: How variables in the data map onto the plot
(<em>e.g.</em>, what’s on the x-axis? what’s on the y-axis?)</li>
  <li><strong>[geom]</strong>: The geometry of the figure or the kind of figure you
want to make (<em>e.g.</em>, what do you want to <strong>do</strong> with those data and
mappings? A line graph? A box plot?…)</li>
</ul>

<p>We’ll start by making a histogram again. To help make these pieces
clearer, I’ll use the argument names when possible. The first
function, which initializes the plot is <code class="language-plaintext highlighter-rouge">ggplot()</code>. Its first
argument is the data.</p>

<p>The aesthetic mappings, that is, which variables go where or how they
function on the plot, go inside the <code class="language-plaintext highlighter-rouge">aes()</code> function. Since we only
have one variable, <code class="language-plaintext highlighter-rouge">x1txmtscor</code>, it is assigned to <code class="language-plaintext highlighter-rouge">x</code>.</p>

<p>If we assign this first part to an object, <code class="language-plaintext highlighter-rouge">p</code>, and print by calling
the object…</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## init ggplot </span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_hs</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1txmtscor</span><span class="p">))</span><span class="w">
</span><span class="n">p</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/eda_plot_histogram_blank-1.png" title="plot of chunk eda_plot_histogram_blank" alt="plot of chunk eda_plot_histogram_blank" width="100%" /></p>

<p>…nothing! Well, not nothing, but no histogram. That’s because the
plot object <code class="language-plaintext highlighter-rouge">p</code> knows the data and the key variable mapping but
doesn’t know what do with them. What do we want?</p>

<p>Since we want a histogram, we add the <code class="language-plaintext highlighter-rouge">geom_histogram()</code> function to
the existing plot object with a plus sign(<code class="language-plaintext highlighter-rouge">+</code>). Once we do that, we’ll
try to print the plot again…</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## add histogram instruction (notice we can add pieces using +)</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">geom_histogram</span><span class="p">()</span><span class="w">
</span><span class="n">p</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/eda_plot_histogram-1.png" title="plot of chunk eda_plot_histogram" alt="plot of chunk eda_plot_histogram" width="100%" /></p>

<p>Success!</p>

<p>Let’s repeat it the whole process, but without the middle step:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## create histogram using ggplot</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_hs</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1txmtscor</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_histogram</span><span class="p">()</span><span class="w">
</span><span class="n">p</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/eda_plot_histogram_2-1.png" title="plot of chunk eda_plot_histogram_2" alt="plot of chunk eda_plot_histogram_2" width="100%" /></p>

<p>As you can see, the code to make a ggplot2 figure looks a lot like
what we’ve seen with other tidyverse libraries, <em>e.g.</em> dplyr. The key
difference between ggplot2 and dplyr, however, is that while dplyr
uses the pipe (<code class="language-plaintext highlighter-rouge">%&gt;%</code>) to connect different functions, ggplot2 uses a
plus sign (<code class="language-plaintext highlighter-rouge">+</code>).</p>

<p>It may help you remember the difference:</p>

<ul>
  <li>dplyr <em>moves</em> output from left to the input in the right and so
needs a <strong>pipe</strong> (<code class="language-plaintext highlighter-rouge">%&gt;%</code>)</li>
  <li>ggplot2 <em>adds</em> layer upon layer to build up the final figure and
so needs a <strong>plus sign</strong> (<code class="language-plaintext highlighter-rouge">+</code>)</li>
</ul>

<h2 id="density-1">Density</h2>

<p>Unlike the base R graphics system, ggplot2 does have a density
plotting command, <code class="language-plaintext highlighter-rouge">geom_density()</code>. Instead of building up the figure
piecemeal, we’ll go ahead and chain the geom to the first command and
print.</p>

<p>Notice how the function chain is the mostly the same as above, but (1)
written in a single linked chain and (2) using a different <code class="language-plaintext highlighter-rouge">geom_*()</code>
command at the end to indicate that we want something different.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## density</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_hs</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1txmtscor</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_density</span><span class="p">()</span><span class="w">
</span><span class="n">p</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/eda_plot_density-1.png" title="plot of chunk eda_plot_density" alt="plot of chunk eda_plot_density" width="100%" /></p>

<blockquote>
  <h4 id="quick-exercise-3">Quick exercise</h4>
  <p>Make a density plot of SES.</p>
</blockquote>

<p>If we want to superimpose the density plot over the histogram, we only
need chain the two commands together with a slight modification in how
the histogram is made. This way, the histogram and the density will be
on the same scale.</p>

<p>The change happens in the <code class="language-plaintext highlighter-rouge">geom_histogram()</code> function, where we add a
new mapping: <code class="language-plaintext highlighter-rouge">aes(y = ..density..)</code>. (<strong>NOTE:</strong> this is similar to what we
did above in base R to make a histogram on a density scale.)</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## histogram with density plot overlapping</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_hs</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1txmtscor</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">..density..</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_density</span><span class="p">()</span><span class="w">
</span><span class="n">p</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/eda_plot_histdens-1.png" title="plot of chunk eda_plot_histdens" alt="plot of chunk eda_plot_histdens" width="100%" /></p>

<p>It worked, but it’s not the greatest visual since the colors are the
same and the density plot is thin with no fill.</p>

<p>Adding to what came before, the <code class="language-plaintext highlighter-rouge">geom_histogram()</code> and
<code class="language-plaintext highlighter-rouge">geom_density()</code> both take on new arguments that change the
defaults. Now the resulting plot should look nicer and be easier to
read.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## histogram with density plot overlapping (add color to see better)</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_hs</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1txmtscor</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">..density..</span><span class="p">),</span><span class="w">
                   </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">,</span><span class="w">
                   </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"white"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_density</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"red"</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.2</span><span class="p">)</span><span class="w">
</span><span class="n">p</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/eda_plot_histdens_2-1.png" title="plot of chunk eda_plot_histdens_2" alt="plot of chunk eda_plot_histdens_2" width="100%" /></p>

<blockquote>
  <h4 id="quick-exercise-4">Quick exercise</h4>
  <p>Try changing some of the arguments in the last plot. What happens
when you change <code class="language-plaintext highlighter-rouge">alpha</code> (keep the value between 0 and 1)? What does
the <code class="language-plaintext highlighter-rouge">color</code> argument change? And <code class="language-plaintext highlighter-rouge">fill</code>? What happens if you switch
the <code class="language-plaintext highlighter-rouge">geom_*()</code> functions, call <code class="language-plaintext highlighter-rouge">geom_histogram()</code> after you call
<code class="language-plaintext highlighter-rouge">geom_density()</code>?</p>
</blockquote>

<p><strong>A key thing to note about arguments</strong> is that when the are outside
of the <code class="language-plaintext highlighter-rouge">aes()</code>, they apply uniformly to the whole geom (<em>e.g.</em> all the
histogram bars are white with a black outline, the density is light
red). When you want some aesthetic of the figure to change as a
function of the data, you need to put it inside <code class="language-plaintext highlighter-rouge">aes()</code>. We’ll see
this in the next plot.</p>

<h2 id="two-way">Two-way</h2>

<p>Plotting the difference in a continuous distribution across groups is
a common task. Let’s see the difference between student math scores
between students with parents who have any postsecondary degree and
those without.</p>

<p>Since we’re using data that was labeled in Stata, we’ll see the
labels when we use <code class="language-plaintext highlighter-rouge">count()</code></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## see the counts for each group</span><span class="w">
</span><span class="n">df_hs</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">count</span><span class="p">(</span><span class="n">x1paredu</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## # A tibble: 7 × 2
##                                       x1paredu     n
##                                      &lt;dbl+lbl&gt; &lt;int&gt;
## 1  1 [Less than high school]                    1010
## 2  2 [High school diploma or GED]               5909
## 3  3 [Associate's degree]                       2549
## 4  4 [Bachelor's degree]                        4102
## 5  5 [Master's degree]                          2116
## 6  7 [Ph.D/M.D/Law/other high lvl prof degree]  1096
## 7 NA                                            6721
</code></pre></div></div>

<p>We can see that all values of <code class="language-plaintext highlighter-rouge">x1paredu</code> greater than 2 represent
parents with some college credential. Since we want only two distinct
groups, we can use the operator <code class="language-plaintext highlighter-rouge">&gt;=</code> to make a new 0/1 binary
variable. If a value of <code class="language-plaintext highlighter-rouge">x1paredu</code> is above 3, then the new indicator
<code class="language-plaintext highlighter-rouge">pared_coll</code> will be 1; if not, 0.</p>

<p><strong>NOTE</strong> that in the Stata version of <code class="language-plaintext highlighter-rouge">hsls_small</code>, all the missing
values, which are normally negative numbers, have already been
properly converted to <code class="language-plaintext highlighter-rouge">NA</code> values. That’s why we see a count column
for <code class="language-plaintext highlighter-rouge">NA</code> and not labels for missingness that we might have expected
based on prior lessons.</p>

<p>The <code class="language-plaintext highlighter-rouge">ggplot()</code> function doesn’t need to use our full data. In fact,
our data needs to be set up a bit differently to make this plot. We’ll
make a new temporary data object that only has the data we need.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## need to set up data</span><span class="w">
</span><span class="n">plot_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df_hs</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## select the columns we need</span><span class="w">
    </span><span class="n">select</span><span class="p">(</span><span class="n">x1paredu</span><span class="p">,</span><span class="w"> </span><span class="n">x1txmtscor</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## can't plot NA so will drop</span><span class="w">
    </span><span class="n">drop_na</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## create new variable that == 1 if parents have any college</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">pared_coll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">x1paredu</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## drop (using negative sign) the original variable we don't need now</span><span class="w">
    </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">x1paredu</span><span class="p">)</span><span class="w"> 

</span><span class="c1">## show</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">plot_df</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## # A tibble: 6 × 2
##   x1txmtscor pared_coll
##    &lt;dbl+lbl&gt;      &lt;dbl&gt;
## 1       59.4          1
## 2       47.7          1
## 3       64.2          1
## 4       49.3          1
## 5       62.6          1
## 6       58.1          1
</code></pre></div></div>

<p>To plot against the two groups we’ve made, we need to add it to the
aesthetic feature, <code class="language-plaintext highlighter-rouge">aes()</code>. The math score, <code class="language-plaintext highlighter-rouge">x1txmtscor</code>, is still
mapped to <code class="language-plaintext highlighter-rouge">x</code>, but since we want two side-by-side histograms, we set
the <code class="language-plaintext highlighter-rouge">fill</code> aesthetic to our new indicator variable. So the function
knows that it’s a group (and not just a continuous number with only
two values), we wrap it in the <code class="language-plaintext highlighter-rouge">factor()</code> function.</p>

<p>Finally, we add some changes to the <code class="language-plaintext highlighter-rouge">geom_histogram()</code> function so that
each group is on the same scale.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## two way histogram</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plot_df</span><span class="p">,</span><span class="w">
            </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1txmtscor</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">pared_coll</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"density"</span><span class="p">,</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"identity"</span><span class="p">)</span><span class="w">
</span><span class="n">p</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/eda_plot_histogram_double-1.png" title="plot of chunk eda_plot_histogram_double" alt="plot of chunk eda_plot_histogram_double" width="100%" /></p>

<p>By assigning <code class="language-plaintext highlighter-rouge">pared_coll</code> to the <code class="language-plaintext highlighter-rouge">fill</code> aesthetic, we can see a
difference in the distribution of math test scores between students
whose parents have at least some college and those whose parents do
not.</p>

<blockquote>
  <h4 id="quick-exercise-5">Quick exercise</h4>
  <p>Remove some of the new arguments in <code class="language-plaintext highlighter-rouge">geom_histogram()</code>. How does the
resulting plot change? Remove the <code class="language-plaintext highlighter-rouge">factor()</code> function from around
<code class="language-plaintext highlighter-rouge">pared_coll</code>: what happens?</p>
</blockquote>

<h2 id="box-plot-1">Box plot</h2>

<p>By this point, you’re hopefully seeing the pattern in how ggplot2
figures are put together. To make a box plot, we need to add a <code class="language-plaintext highlighter-rouge">y</code>
mapping to the <code class="language-plaintext highlighter-rouge">aes()</code> in addition to the <code class="language-plaintext highlighter-rouge">x</code> mapping. We’ve also
added the same variable to <code class="language-plaintext highlighter-rouge">fill</code> as we did to <code class="language-plaintext highlighter-rouge">x</code>.  We do this so
that in addition to having different box and whisker plots along the
x-axis, each plot is given its own color.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## box plot using both factor() and as_factor()</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_hs</span><span class="p">,</span><span class="w">
            </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">x1paredu</span><span class="p">),</span><span class="w">
                          </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1txmtscor</span><span class="p">,</span><span class="w">
                          </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as_factor</span><span class="p">(</span><span class="n">x1paredu</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_boxplot</span><span class="p">()</span><span class="w">
</span><span class="n">p</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/eda_plot_box-1.png" title="plot of chunk eda_plot_box" alt="plot of chunk eda_plot_box" width="100%" /></p>

<p>In a way, this plot is similar to the dual histogram above. But since
we want to see the distribution of math scores across finer-grained
levels of parental education, the box and whisker plot is clearer than
trying to overlap seven histograms.</p>

<blockquote>
  <h4 id="quick-exercise-6">Quick exercise</h4>
  <p>Change the <code class="language-plaintext highlighter-rouge">as_factor()</code> and <code class="language-plaintext highlighter-rouge">factor()</code> functions above. How does
the plot change?</p>
</blockquote>

<h1 id="scatter-1">Scatter</h1>

<p>To make a scatter plot, make sure that the <code class="language-plaintext highlighter-rouge">aes()</code> has mappings for
the <code class="language-plaintext highlighter-rouge">x</code> axis and <code class="language-plaintext highlighter-rouge">y</code> axis and then use <code class="language-plaintext highlighter-rouge">geom_point()</code> to plot. To make
things easier to see (remembering the cloud from the base R plot
above), we’ll reduce the data to 10% of the full sample using
<code class="language-plaintext highlighter-rouge">sample_frac()</code> from dplyr. We’ll also limit our 10% to those who
aren’t missing information about student education expectations</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## sample 10% to make figure clearer</span><span class="w">
</span><span class="n">df_hs_10</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df_hs</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## drop observations with missing values for x1stuedexpct</span><span class="w">
    </span><span class="n">drop_na</span><span class="p">(</span><span class="n">x1stuedexpct</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## sample</span><span class="w">
    </span><span class="n">sample_frac</span><span class="p">(</span><span class="m">0.1</span><span class="p">)</span><span class="w">

</span><span class="c1">## scatter</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_hs_10</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1ses</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1txmtscor</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_point</span><span class="p">()</span><span class="w">
</span><span class="n">p</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/eda_plot_scatter_1-1.png" title="plot of chunk eda_plot_scatter_1" alt="plot of chunk eda_plot_scatter_1" width="100%" /></p>

<p>Now that we have our scatter plot, let’s say that we want to add a
third dimension. Specifically, we want to change the color of each
point based on whether a student plans to earn a Bachelor’s degree or
higher. That means we need a new dummy variable that is 1 for those
with BA/BS plans and 0 for others.</p>

<p>We can look at the student base year expectations with <code class="language-plaintext highlighter-rouge">count()</code>:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## see student base year plans</span><span class="w">
</span><span class="n">df_hs</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">count</span><span class="p">(</span><span class="n">x1stuedexpct</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## # A tibble: 12 × 2
##                                    x1stuedexpct     n
##                                       &lt;dbl+lbl&gt; &lt;int&gt;
##  1  1 [Less than high school]                      93
##  2  2 [High school diploma or GED]               2619
##  3  3 [Start an Associate's degree]               140
##  4  4 [Complete an Associate's degree]           1195
##  5  5 [Start a Bachelor's degree]                 115
##  6  6 [Complete a Bachelor's degree]             3505
##  7  7 [Start a Master's degree]                   231
##  8  8 [Complete a Master's degree]               4278
##  9  9 [Start Ph.D/M.D/Law/other prof degree]      176
## 10 10 [Complete Ph.D/M.D/Law/other prof degree]  4461
## 11 11 [Don't know]                               4631
## 12 NA                                            2059
</code></pre></div></div>

<p>We see that <code class="language-plaintext highlighter-rouge">x1stuedexpct &gt;= 6</code> means a student plans to earn a
Bachelor’s degree or higher. But since we need to account for the fact
that 11 means “I don’t know”, we need to make sure our test includes
<code class="language-plaintext highlighter-rouge">x1stuedexpct &lt; 11</code>. Remember from a prior lesson that we can connect
these two statements together with the operator <code class="language-plaintext highlighter-rouge">&amp;</code>. Let’s create our
new variable.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## create variable for students who plan to graduate from college</span><span class="w">
</span><span class="n">df_hs_10</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df_hs_10</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">plan_col_grad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">x1stuedexpct</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">x1stuedexpct</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">11</span><span class="p">,</span><span class="w">
                                  </span><span class="m">1</span><span class="p">,</span><span class="w">        </span><span class="c1"># if T: 1</span><span class="w">
                                  </span><span class="m">0</span><span class="p">))</span><span class="w">       </span><span class="c1"># if F: 0</span><span class="w">
</span></code></pre></div></div>

<p>Now that we have our new variable <code class="language-plaintext highlighter-rouge">plan_col_grad</code>, we can add it the
<code class="language-plaintext highlighter-rouge">color</code> aesthetic, <code class="language-plaintext highlighter-rouge">aes()</code> in <code class="language-plaintext highlighter-rouge">geom_point()</code>. Don’t forget to use
<code class="language-plaintext highlighter-rouge">factor()</code> so that ggplot knows to treat it like a group!</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## scatter</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_hs_10</span><span class="p">,</span><span class="w">
            </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1ses</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1txmtscor</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_point</span><span class="p">(</span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">plan_col_grad</span><span class="p">)),</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">)</span><span class="w">
</span><span class="n">p</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/eda_plot_scatter_2-1.png" title="plot of chunk eda_plot_scatter_2" alt="plot of chunk eda_plot_scatter_2" width="100%" /></p>

<blockquote>
  <h4 id="quick-exercise-7">Quick exercise</h4>
  <p>Change how you make <code class="language-plaintext highlighter-rouge">plan_col_grad</code> so that instead of 1 and 0, you
use ‘yes’ and ‘no’. Make your figure again. What changes?</p>
</blockquote>

<h2 id="fitted-lines">Fitted lines</h2>

<p>It’s often helpful to plot fitted lines against a scatter plot to help
see the underlying trend. There are a number of ways to do this with
the <code class="language-plaintext highlighter-rouge">geom_smooth()</code> function.</p>

<h3 id="linear-fit">Linear fit</h3>

<p>Setting <code class="language-plaintext highlighter-rouge">method = lm</code> in <code class="language-plaintext highlighter-rouge">geom_smooth()</code> will fit a simple straight
line of best fit with 95% confidence interval shaded around it.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## add fitted line with linear fit</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_hs_10</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1ses</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1txmtscor</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_point</span><span class="p">(</span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">plan_col_grad</span><span class="p">)),</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_smooth</span><span class="p">(</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lm</span><span class="p">)</span><span class="w">
</span><span class="n">p</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/eda_plot_scatter_3-1.png" title="plot of chunk eda_plot_scatter_3" alt="plot of chunk eda_plot_scatter_3" width="100%" /></p>

<h3 id="linear-fit-with-polynomials">Linear fit with polynomials</h3>

<p>In addition to the <code class="language-plaintext highlighter-rouge">method</code>, we can add a <code class="language-plaintext highlighter-rouge">formula</code> to allow the
fitted line to take a non-linear shape. Using the <code class="language-plaintext highlighter-rouge">aes()</code> values of
<code class="language-plaintext highlighter-rouge">x</code> and <code class="language-plaintext highlighter-rouge">y</code>, the argument below uses an R formula, <code class="language-plaintext highlighter-rouge">y ~ x</code>, but with
the addition of the <code class="language-plaintext highlighter-rouge">poly()</code> function. Setting the second argument in
<code class="language-plaintext highlighter-rouge">poly()</code> to 2 gives the line an extra quadratic term, which allows it
to take a more curved shape.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## add fitted line with polynomial linear fit</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_hs_10</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1ses</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1txmtscor</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_point</span><span class="p">(</span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">plan_col_grad</span><span class="p">)),</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_smooth</span><span class="p">(</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lm</span><span class="p">,</span><span class="w"> </span><span class="n">formula</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">poly</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="m">2</span><span class="p">))</span><span class="w">
</span><span class="n">p</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/eda_plot_scatter_4-1.png" title="plot of chunk eda_plot_scatter_4" alt="plot of chunk eda_plot_scatter_4" width="100%" /></p>

<blockquote>
  <h4 id="quick-exercise-8">Quick exercise</h4>
  <p>Change the value in <code class="language-plaintext highlighter-rouge">poly()</code> to higher numbers. How does the line
change?</p>
</blockquote>

<h3 id="loess">Loess</h3>

<p>Finally, we can skip trying to adjust a linear line and just fit a
<a href="https://en.wikipedia.org/wiki/Local_regression">LOESS</a> curve, which
is a smooth line produced by fitting a large number of local
polynomial regressions on subsets of the data.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## add fitted line with loess</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_hs_10</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1ses</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1txmtscor</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_point</span><span class="p">(</span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">plan_col_grad</span><span class="p">)),</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_smooth</span><span class="p">(</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loess</span><span class="p">)</span><span class="w">
</span><span class="n">p</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/eda_plot_scatter_5-1.png" title="plot of chunk eda_plot_scatter_5" alt="plot of chunk eda_plot_scatter_5" width="100%" /></p>

<p>To be clear, these semi-automated lines of best fit should not be used
to draw final conclusions about the relationships in your data. You
will want to do <strong>much more</strong> analytic work to make sure any
correlations you observe aren’t simply spurious and that fitted lines
are telling you something useful. That said, fitted lines via
ggplot2 can be useful when first trying to understand your data or
to more clearly show observed trends.</p>

<h2 id="line-graph">Line graph</h2>

<p>When you want to show changes in one variable as a function of another
variable, <em>e.g.</em>, changes in test scores over time, then a line graph
is often a good choice. Since our <code class="language-plaintext highlighter-rouge">hsls_small</code> data is
cross-sectional, we’ll shift to using our school test score
data. Remember that the test score data show three sets of test scores
(math, science, and reading) for four schools over a period of six
years. This data frame is long in year, but wide in test type. It
looks like this:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## show test score data</span><span class="w">
</span><span class="n">df_ts</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## # A tibble: 24 × 5
##    school        year  math  read science
##    &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
##  1 Bend Gate     1980   515   281     808
##  2 Bend Gate     1981   503   312     814
##  3 Bend Gate     1982   514   316     816
##  4 Bend Gate     1983   491   276     793
##  5 Bend Gate     1984   502   310     788
##  6 Bend Gate     1985   488   280     789
##  7 East Heights  1980   501   318     782
##  8 East Heights  1981   487   323     813
##  9 East Heights  1982   496   294     818
## 10 East Heights  1983   497   306     795
## # … with 14 more rows
</code></pre></div></div>

<p>To keep it simple for our first line plot, we’ll filter our plot data
to keep only scores for one school. Notice how we can do that directly
with pipes inside the <code class="language-plaintext highlighter-rouge">ggplot()</code> function. We want to see changes in
test scores over time, so we’ll map <code class="language-plaintext highlighter-rouge">year</code> to the <code class="language-plaintext highlighter-rouge">x</code> axis and, for
now, <code class="language-plaintext highlighter-rouge">math</code> to the <code class="language-plaintext highlighter-rouge">y</code> axis. To see a line graph, we add
<code class="language-plaintext highlighter-rouge">geom_line()</code>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## line graph</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_ts</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">school</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Spottsville"</span><span class="p">),</span><span class="w">
            </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">math</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_line</span><span class="p">()</span><span class="w">
</span><span class="n">p</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/unnamed-chunk-24-1.png" title="plot of chunk unnamed-chunk-24" alt="plot of chunk unnamed-chunk-24" width="100%" /></p>

<blockquote>
  <h4 id="quick-exercise-9">QUICK EXERCISE</h4>
  <p>Change the school in <code class="language-plaintext highlighter-rouge">filter()</code> to “East Heights” and then “Bend
Gate”.</p>
</blockquote>

<p>Easy enough, but let’s say that we want to add a third dimension —
to show math scores for each school in the same plot area. To do this,
we can map a third aesthetic to <code class="language-plaintext highlighter-rouge">school</code>. <a href="https://ggplot2.tidyverse.org/reference/geom_path.html#aesthetics">Looking at the help file
for
<code class="language-plaintext highlighter-rouge">geom_line()</code></a>,
we see that lines (a version of a path) can take <code class="language-plaintext highlighter-rouge">colour</code>, which means
we can change line color based on a variable.</p>

<p>The code below is almost exactly the same as before less two things:</p>

<ol>
  <li>We don’t filter <code class="language-plaintext highlighter-rouge">df_ts</code> this time, because we want all schools</li>
  <li>We add <code class="language-plaintext highlighter-rouge">colour = school</code> inside <code class="language-plaintext highlighter-rouge">aes()</code></li>
</ol>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## line graph for math scores at every school over time</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_ts</span><span class="p">,</span><span class="w">
            </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">math</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">school</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_line</span><span class="p">()</span><span class="w">
</span><span class="n">p</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/unnamed-chunk-25-1.png" title="plot of chunk unnamed-chunk-25" alt="plot of chunk unnamed-chunk-25" width="100%" /></p>

<p>This is nice (though maybe a little messy at the moment) because it
allows us to compare math scores across time across schools. But we
have two more test types — reading and science — that we would
like to include as well. One approach that will let us add yet another
dimension is to use facets.</p>

<h2 id="facets">Facets</h2>

<p>With facets, we can put multiple plots together, each showing some
subset of the data. For example, instead of plotting changes in math
scores across schools over time on the same plot area (only changing
the color), we can use <code class="language-plaintext highlighter-rouge">facet_wrap()</code> to give each school its own
little plot. You might hear me or other refer to plots like this a
showing <em>small multiples</em> or as <em>small multiples</em> figures.</p>

<p>Compared to the code just above, notice how we’ve removed
<code class="language-plaintext highlighter-rouge">colour = school</code> from <code class="language-plaintext highlighter-rouge">aes()</code> and included <code class="language-plaintext highlighter-rouge">facet_wrap(~
school)</code>. The tilde (<code class="language-plaintext highlighter-rouge">~</code>) works like the tilde in <code class="language-plaintext highlighter-rouge">plot(y ~ x)</code> above:
it means “plot against or by <em>X</em>”. In this case, we are plotting math
test scores over time <em>by</em> each school.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## facet line graph</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_ts</span><span class="p">,</span><span class="w">
            </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">math</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="w"> </span><span class="n">school</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_line</span><span class="p">()</span><span class="w">
</span><span class="n">p</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/unnamed-chunk-26-1.png" title="plot of chunk unnamed-chunk-26" alt="plot of chunk unnamed-chunk-26" width="100%" /></p>

<p>Is this faceted plot better than the color line plot before it? To my
eyes, it’s a little clearer, but not so much so that I couldn’t be
convinced to use the first one. Whether you use the first or the
second would largely depend on your specific data and presentation
needs.</p>

<p>Faceting has a clearer advantage, however, when you want to include
the fourth level of comparison: (1) scores across (2) time across (3)
schools from (4) different tests. To make this comparison, we first
need to reshape our data, which is only long in <code class="language-plaintext highlighter-rouge">year</code>, to be long in
<code class="language-plaintext highlighter-rouge">test</code>, too. As we’ve already seen in a past lesson, we’ll use
<code class="language-plaintext highlighter-rouge">pivot_longer()</code> to place each test type in its own column (<code class="language-plaintext highlighter-rouge">test</code>)
with the <code class="language-plaintext highlighter-rouge">score</code> next to it.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## reshape data long</span><span class="w">
</span><span class="n">df_ts_long</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df_ts</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">pivot_longer</span><span class="p">(</span><span class="n">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"math"</span><span class="p">,</span><span class="s2">"read"</span><span class="p">,</span><span class="s2">"science"</span><span class="p">),</span><span class="w"> </span><span class="c1"># cols to pivot long</span><span class="w">
                 </span><span class="n">names_to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test"</span><span class="p">,</span><span class="w">                 </span><span class="c1"># where col names go</span><span class="w">
                 </span><span class="n">values_to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"score"</span><span class="p">)</span><span class="w">               </span><span class="c1"># where col values go</span><span class="w">

</span><span class="c1">## show</span><span class="w">
</span><span class="n">df_ts_long</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## # A tibble: 72 × 4
##    school     year test    score
##    &lt;chr&gt;     &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt;
##  1 Bend Gate  1980 math      515
##  2 Bend Gate  1980 read      281
##  3 Bend Gate  1980 science   808
##  4 Bend Gate  1981 math      503
##  5 Bend Gate  1981 read      312
##  6 Bend Gate  1981 science   814
##  7 Bend Gate  1982 math      514
##  8 Bend Gate  1982 read      316
##  9 Bend Gate  1982 science   816
## 10 Bend Gate  1983 math      491
## # … with 62 more rows
</code></pre></div></div>

<blockquote>
  <h4 id="quick-exercise-10">QUICK EXERCISE</h4>
  <p>If we have 4 schools, 6 years, and 3 tests, how many observations
should <code class="language-plaintext highlighter-rouge">df_ts_long</code> have in total? Does it?</p>
</blockquote>

<p>With our reshaped data frame, we now reintroduce <code class="language-plaintext highlighter-rouge">colour</code> into the
<code class="language-plaintext highlighter-rouge">aes()</code>, this time set to <code class="language-plaintext highlighter-rouge">test</code>. We make one other change: <code class="language-plaintext highlighter-rouge">y =
score</code> now, since that’s the column for test scores in our reshaped
data. All else is the same.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## facet line graph, with colour = test and ~school</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_ts_long</span><span class="p">,</span><span class="w">
            </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">score</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="w"> </span><span class="n">school</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_line</span><span class="p">()</span><span class="w">
</span><span class="n">p</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/unnamed-chunk-28-1.png" title="plot of chunk unnamed-chunk-28" alt="plot of chunk unnamed-chunk-28" width="100%" /></p>

<p>Well, it worked…we can see each school’s different test score trends
over time, with each school in its own facet and test scores set to a
different color. But the result is a bit underwhelming. Because the
different test types are such different scales (even though they are
normed within themselves), within-test changes seem rather flat over
time.</p>

<p>Let’s try something different: in the next figure, we’ll swap the
variables we give to <code class="language-plaintext highlighter-rouge">colour</code> and within <code class="language-plaintext highlighter-rouge">facet_wrap()</code>. This means
that each test should have its own facet and each line will represent
a different school.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## facet line graph, now with colour = school and ~test</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_ts_long</span><span class="p">,</span><span class="w">
            </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">score</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">school</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="w"> </span><span class="n">test</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_line</span><span class="p">()</span><span class="w">
</span><span class="n">p</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/unnamed-chunk-29-1.png" title="plot of chunk unnamed-chunk-29" alt="plot of chunk unnamed-chunk-29" width="100%" /></p>

<p>Okay. New problem. While it’s maybe a <em>little</em> easier to see same-test
differences across schools over time, the different scales of the
tests still make the figure less useful than we might hope. It’s not
that the students are <em>way</em> better at science than reading; it’s just
that the tests are scaled differently. Someone quickly reading this
figure, however, might make that incorrect interpretation.</p>

<p>One thing we can do is change the y-axis for each facet. The default is
to keep the y-axis scale the same. By adding <code class="language-plaintext highlighter-rouge">scales = "free_y"</code> to
<code class="language-plaintext highlighter-rouge">facet_wrap()</code>, we’ll let each test have its own y-axis scale.</p>

<p>Having different axis scales side-by-side can be confusing, however
(this is why the default is to keep them the same). To mitigate that
confusion, we’ll also rearrange the facets so they stack rather than
sit side by side. To do this, we’ll add <code class="language-plaintext highlighter-rouge">ncol = 1</code> to
<code class="language-plaintext highlighter-rouge">facet_wrap()</code>. This says our facets have to stick to one column,
effectively meaning they will stack vertically.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## facet line graph, with one column so they stack</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_ts_long</span><span class="p">,</span><span class="w">
            </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">score</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">school</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="w"> </span><span class="n">test</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">scales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"free_y"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_line</span><span class="p">()</span><span class="w">
</span><span class="n">p</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/unnamed-chunk-30-1.png" title="plot of chunk unnamed-chunk-30" alt="plot of chunk unnamed-chunk-30" width="100%" /></p>

<p>That looks better! But we can do even better than that…</p>

<p>Currently, each test score is on its own normed scale. While our new
figure allows us to make comparisons across schools over time <em>within</em>
test, it’s more difficult to make a good comparison <em>between</em>
tests. For example, East Heights has a little over 20 point drop in
reading scores from 1981 to 1982 and about the same drop in science
scores from 1982 to 1983. How should we think about these drops? Are
they about the same or is one drop relatively bigger than the other?</p>

<p>To better answer this question, we could re-standardize each test
score so that it is centered at 0 and a one unit change is equal to 1
standard deviation difference in score. We’ll use <code class="language-plaintext highlighter-rouge">mutate()</code> to create
a new variable <code class="language-plaintext highlighter-rouge">score_std</code>. Because we <code class="language-plaintext highlighter-rouge">group_by()</code> <code class="language-plaintext highlighter-rouge">test</code>,
<code class="language-plaintext highlighter-rouge">score_std</code> will be standardized within test.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## rescale test scores</span><span class="w">
</span><span class="n">df_ts_long</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df_ts_long</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">group_by</span><span class="p">(</span><span class="n">test</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">score_std</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">score</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">score</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">sd</span><span class="p">(</span><span class="n">score</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">ungroup</span><span class="w">
</span></code></pre></div></div>

<p>We’ll repeat the same code as before, but this time substitute <code class="language-plaintext highlighter-rouge">y =
score_std</code>. Because all tests are on the same standardized scale, we
can also drop <code class="language-plaintext highlighter-rouge">scales = "free_y"</code>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## facet line graph with standardized test scores</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_ts_long</span><span class="p">,</span><span class="w">
            </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">score_std</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">school</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="w"> </span><span class="n">test</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_line</span><span class="p">()</span><span class="w">
</span><span class="n">p</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/unnamed-chunk-32-1.png" title="plot of chunk unnamed-chunk-32" alt="plot of chunk unnamed-chunk-32" width="100%" /></p>

<p>Notice the lines look the same relative to one another, but now we
have a consistent scale to help judge changes. To answer our question
from before, it seems that the drop in reading scores (1981 to 1982)
and science scores (1982 to 1983) were each about 1.5 standard
deviations. We could test more formally, but we have a clearer idea
now that all tests are on the same scale.</p>

<blockquote>
  <h4 id="quick-exercise-11">QUICK EXERCISE</h4>
  <p>What happens if you use the argument <code class="language-plaintext highlighter-rouge">scales = "free_y"</code> in the last
bit of code? Why might you not use that once we’ve scaled the test
scores?</p>
</blockquote>

<p>As a quick change, we can go back to having each school in its own
facet and test scores within.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## facet line graph</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_ts_long</span><span class="p">,</span><span class="w">
            </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">score_std</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="w"> </span><span class="n">school</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_line</span><span class="p">()</span><span class="w">
</span><span class="n">p</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/unnamed-chunk-33-1.png" title="plot of chunk unnamed-chunk-33" alt="plot of chunk unnamed-chunk-33" width="100%" /></p>

<blockquote>
  <h4 id="quick-exercise-12">QUICK EXERCISE</h4>
  <p>Why did we drop <code class="language-plaintext highlighter-rouge">ncol = 1</code> from <code class="language-plaintext highlighter-rouge">facet_wrap()</code>? What happens if you
keep it?</p>
</blockquote>

<p>Our plot is looking better, but it still may not contain the
information we want. We’ve standardized the test scores over this time
window, but maybe what we really want to know is how they’ve <em>changed
relative to the beginning of the sample period</em>. You can imagine a
superintendent who took over in 1981 would be keen to know how scores
have changed during their tenure.</p>

<p>This means that while we still want to standardize the scores, we
should zero them not at the overall mean, but at the value in the first
year. We can do that by grouping by <code class="language-plaintext highlighter-rouge">school</code> and <code class="language-plaintext highlighter-rouge">test</code>, arranging in
year order, making a new variable that is the <code class="language-plaintext highlighter-rouge">first()</code> score (within
test, within school) and using that rather than the mean test score to
make our new variable, <code class="language-plaintext highlighter-rouge">score_std_sch</code>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## standardize test scores within school to first year</span><span class="w">
</span><span class="n">df_ts_long</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df_ts_long</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">group_by</span><span class="p">(</span><span class="n">test</span><span class="p">,</span><span class="w"> </span><span class="n">school</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">arrange</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">score_year_one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="p">(</span><span class="n">score</span><span class="p">),</span><span class="w">
           </span><span class="c1">## note that we're using score_year_one instead of mean(score)</span><span class="w">
           </span><span class="n">score_std_sch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">score</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">score_year_one</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">sd</span><span class="p">(</span><span class="n">score</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">ungroup</span><span class="w">
</span></code></pre></div></div>

<p>Now we’ll plot using our new variable <code class="language-plaintext highlighter-rouge">score_std_sch</code>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## facet line graph</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_ts_long</span><span class="p">,</span><span class="w">
            </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">score_std_sch</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="w"> </span><span class="n">school</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_line</span><span class="p">()</span><span class="w">
</span><span class="n">p</span><span class="w">
</span></code></pre></div></div>

<p><img src="../figures/unnamed-chunk-35-1.png" title="plot of chunk unnamed-chunk-35" alt="plot of chunk unnamed-chunk-35" width="100%" /></p>

<p>With this final graph, we can see relative changes across schools,
across times, across tests. Notice that line shapes within each facet
are the same as before, just shifted up or down so that the first
value for each test in 1981 is 0.</p>

<p>Is this the best version of this figure (minus making the axis and
legend labels look nicer)?  Again, it depends on what you want to
show. Remember that figures don’t speak for themselves: it’s up to you
to explain to your reader (include your future self) what they
mean. That said, a well crafted figure will make that job much easier.</p>




	<!-- <p> -->
	<!--   Updated:  -->
	<!-- </p> -->
      </section>
      <footer>
        <p>
  Benjamin Skinner</br>  
  Assistant Professor</br>  
  University of Florida</br>
  <a href="https://www.btskinner.io" class="iconlink" alt="Personal website">
    <i class="fas fa-home fa-lg"></i></a> | 
  <a href="https://github.com/btskinner" class="iconlink" alt="Github
								profile">
    <i class="fab fa-github fa-lg"></i></a> |
  <a href="https://twitter.com/btskinner" class="iconlink" alt="Twitter profile">
    <i class="fab fa-twitter fa-lg"></i></a>
</p>
<p>
  <small>
    <a href="https://pages.github.com">GitHub Pages</a> |
    <a href="https://github.com/orderedlist/minimal">Theme</a> |
    <a href="/edh7916/releases/">Releases</a>
  </small>
</p>

      </footer>
    </div>

    <!-- load Javascript if page requires it -->
    
    
    

    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-63981025-1', 'auto');
        ga('send', 'pageview');
    </script>
  
  </body>
</html>
